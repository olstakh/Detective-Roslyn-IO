@page "/admin/challenges/create"
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout
@inject IChallengeService ChallengeService
@inject NavigationManager Navigation

<PageTitle>Create Challenge - Admin</PageTitle>

<h1>Create New Challenge</h1>

<div class="card">
    <div class="card-body">
        <EditForm Model="challenge" OnValidSubmit="HandleSubmit">
            <div class="mb-3">
                <label class="form-label">Title</label>
                <InputText @bind-Value="challenge.Title" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <InputTextArea @bind-Value="challenge.Description" class="form-control" rows="3" />
            </div>

            <div class="mb-3">
                <label class="form-label">Instructions</label>
                <InputTextArea @bind-Value="challenge.Instructions" class="form-control" rows="6" />
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Category</label>
                    <InputSelect @bind-Value="challenge.Category" class="form-select">
                        <option value="@ChallengeCategory.Analyzer">Analyzer</option>
                        <option value="@ChallengeCategory.CodeFix">Code Fix</option>
                        <option value="@ChallengeCategory.SourceGenerator">Source Generator</option>
                    </InputSelect>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Difficulty</label>
                    <InputSelect @bind-Value="challenge.Difficulty" class="form-select">
                        <option value="@DifficultyLevel.Beginner">Beginner</option>
                        <option value="@DifficultyLevel.Intermediate">Intermediate</option>
                        <option value="@DifficultyLevel.Advanced">Advanced</option>
                    </InputSelect>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Target Repository URL</label>
                <InputText @bind-Value="challenge.TargetRepoUrl" class="form-control" />
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Expected Answer</label>
                    <InputText @bind-Value="challenge.ExpectedAnswer" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Answer Format</label>
                    <InputSelect @bind-Value="challenge.AnswerFormat" class="form-select">
                        <option value="text">Text</option>
                        <option value="number">Number</option>
                        <option value="comma-separated">Comma Separated</option>
                    </InputSelect>
                </div>
            </div>

            <div class="mb-3">
                <div class="form-check">
                    <InputCheckbox @bind-Value="challenge.CaseSensitive" class="form-check-input" id="caseSensitive" />
                    <label class="form-check-label" for="caseSensitive">
                        Case Sensitive
                    </label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Roslyn Documentation URL (Optional)</label>
                <InputText @bind-Value="challenge.RoslynDocsUrl" class="form-control" />
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Order Index</label>
                    <InputNumber @bind-Value="challenge.OrderIndex" class="form-control" />
                </div>
                <div class="col-md-6">
                    <div class="form-check mt-4">
                        <InputCheckbox @bind-Value="challenge.IsActive" class="form-check-input" id="isActive" />
                        <label class="form-check-label" for="isActive">
                            Is Active
                        </label>
                    </div>
                </div>
            </div>

            <h5 class="mt-4">Hints</h5>
            @for (int i = 0; i < hints.Count; i++)
            {
                var index = i;
                <div class="mb-2">
                    <div class="input-group">
                        <span class="input-group-text">Hint @(index + 1)</span>
                        <input type="text" class="form-control" @bind="hints[index]" />
                        <button type="button" class="btn btn-outline-danger" @onclick="() => RemoveHint(index)">Remove</button>
                    </div>
                </div>
            }
            <button type="button" class="btn btn-outline-secondary btn-sm mb-3" @onclick="AddHint">Add Hint</button>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Create Challenge
                </button>
                <a href="/admin/challenges" class="btn btn-outline-secondary ms-2">Cancel</a>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private Challenge challenge = new()
    {
        Title = "",
        Description = "",
        Instructions = "",
        TargetRepoUrl = "",
        ExpectedAnswer = "",
        AnswerFormat = "text",
        IsActive = true,
        OrderIndex = 1
    };

    private List<string> hints = new();
    private bool isSubmitting;

    private void AddHint()
    {
        hints.Add("");
    }

    private void RemoveHint(int index)
    {
        hints.RemoveAt(index);
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;

        try
        {
            var createdChallenge = await ChallengeService.CreateChallengeAsync(challenge);

            // Add hints if any
            if (hints.Any(h => !string.IsNullOrWhiteSpace(h)))
            {
                var hintEntities = hints
                    .Where(h => !string.IsNullOrWhiteSpace(h))
                    .Select((content, index) => new Hint
                    {
                        ChallengeId = createdChallenge.Id,
                        Content = content,
                        OrderIndex = index + 1
                    })
                    .ToList();

                // Hints will be added via the challenge relationship
                createdChallenge.Hints = hintEntities;
                await ChallengeService.UpdateChallengeAsync(createdChallenge);
            }

            Navigation.NavigateTo("/admin/challenges");
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error creating challenge: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
